name: Build, Test & Docker Deploy

on:
  push:
    branches: 
      - main
      - develop
      - feature/*
      - release/*
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      semantic-version: ${{ steps.version.outputs.semantic-version }}
      branch: ${{ steps.branch.outputs.branch }}
      commit-sha: ${{ steps.version.outputs.commit-sha }}
      build-date: ${{ steps.version.outputs.build-date }}
      build-time: ${{ steps.version.outputs.build-time }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Extract Branch Information
        id: branch
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "branch=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "source-branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            branch_name=${GITHUB_REF#refs/heads/}
            branch_name=${branch_name#refs/tags/}
            # Replace special characters for Docker tag compatibility
            branch_name=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:upper:]' '[:lower:]')
            echo "branch=$branch_name" >> $GITHUB_OUTPUT
            echo "source-branch=$branch_name" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”¢ Generate Version
        id: version
        run: |
          # Get current date and time for versioning
          DATE=$(date +'%Y.%m.%d')
          TIME=$(date +'%H%M')
          COMMIT_SHORT=${GITHUB_SHA::8}
          BRANCH_CLEAN=${{ steps.branch.outputs.branch }}
          
          # Generate semantic-like version based on context
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # For tagged releases, use the tag as version
            VERSION=${{ github.ref_name }}
            SEMANTIC_VERSION=${{ github.ref_name }}
          else
            # For branch pushes, create semantic version
            case "$BRANCH_CLEAN" in
              "main")
                SEMANTIC_VERSION="1.${DATE//.}.${TIME}"
                VERSION="v${SEMANTIC_VERSION}"
                ;;
              "develop")
                SEMANTIC_VERSION="0.${DATE//.}.${TIME}-dev"
                VERSION="v${SEMANTIC_VERSION}"
                ;;
              "feature-"*)
                FEATURE_NAME=${BRANCH_CLEAN#feature-}
                SEMANTIC_VERSION="0.${DATE//.}.${TIME}-${FEATURE_NAME}"
                VERSION="v${SEMANTIC_VERSION}"
                ;;
              "release-"*)
                RELEASE_NAME=${BRANCH_CLEAN#release-}
                SEMANTIC_VERSION="${RELEASE_NAME}.${DATE//.}.${TIME}-rc"
                VERSION="v${SEMANTIC_VERSION}"
                ;;
              *)
                SEMANTIC_VERSION="0.${DATE//.}.${TIME}-${BRANCH_CLEAN}"
                VERSION="v${SEMANTIC_VERSION}"
                ;;
            esac
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "semantic-version=$SEMANTIC_VERSION" >> $GITHUB_OUTPUT
          echo "commit-sha=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "build-date=$DATE" >> $GITHUB_OUTPUT
          echo "build-time=$TIME" >> $GITHUB_OUTPUT
          
          echo "Generated version: $VERSION"
          echo "Semantic version: $SEMANTIC_VERSION"
          echo "Branch: $BRANCH_CLEAN"
          echo "Commit: $COMMIT_SHORT"

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ§¹ Clean & Compile
        run: |
          echo "ðŸ§¹ Cleaning and compiling project..."
          mvn clean compile -B

      - name: ðŸ§ª Run Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          mvn test -B
          
      - name: ðŸ“Š Generate Test Reports
        run: |
          echo "ðŸ“Š Generating test and coverage reports..."
          mvn surefire-report:report jacoco:report -B
        if: always()

      - name: ðŸ“¦ Build WAR Package
        run: |
          echo "ðŸ“¦ Building WAR package..."
          mvn package -DskipTests -B

      - name: ðŸ“¤ Upload WAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-war-${{ steps.version.outputs.version }}
          path: target/*.war
          retention-days: 30

      - name: ðŸ“¤ Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ steps.version.outputs.version }}
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 14

      - name: âœ… Build Summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.branch.outputs.source-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic Version:** ${{ steps.version.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** ${{ steps.version.outputs.build-date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.version.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Expected Docker Tags:" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\` (main branch only)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.version.outputs.semantic-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.version.outputs.build-date }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.version.outputs.commit-sha }}\`" >> $GITHUB_STEP_SUMMARY

  # Job 2: Build and Push Docker Image
  docker-build-push:
    name: ðŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout Repository  
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download WAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp-war-${{ needs.build-and-test.outputs.version }}
          path: target/

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Latest tags for easy identification
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=stable,enable={{is_default_branch}}
            
            # Semantic version tags (primary identification)
            type=raw,value=${{ needs.build-and-test.outputs.version }}
            type=raw,value=${{ needs.build-and-test.outputs.semantic-version }}
            
            # Branch-based tags for environment identification
            type=raw,value={{branch}},enable=${{ needs.build-and-test.outputs.branch == 'main' }}
            type=raw,value={{branch}}-latest,enable=${{ needs.build-and-test.outputs.branch == 'develop' }}
            type=raw,value=dev-latest,enable=${{ needs.build-and-test.outputs.branch == 'develop' }}
            
            # Date-based tags for chronological identification
            type=raw,value=${{ needs.build-and-test.outputs.build-date }}
            type=raw,value=${{ needs.build-and-test.outputs.build-date }}-${{ needs.build-and-test.outputs.commit-sha }}
            
            # Commit-based tags for exact identification
            type=sha,prefix={{branch}}-,format=short
            type=raw,value=${{ needs.build-and-test.outputs.commit-sha }}
            
            # Environment-specific tags
            type=raw,value=production,enable={{is_default_branch}}
            type=raw,value=staging,enable=${{ needs.build-and-test.outputs.branch == 'develop' }}
            
            # Feature branch tags
            type=ref,event=branch,suffix=-{{sha}}
            
            # Release candidate tags
            type=ref,event=tag,suffix=-release
          labels: |
            org.opencontainers.image.title=Maven Tomcat Web App
            org.opencontainers.image.description=Java Web Application with Maven and Tomcat - Branch: ${{ needs.build-and-test.outputs.branch }}
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            org.opencontainers.image.version=${{ needs.build-and-test.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.documentation=${{ github.server_url }}/${{ github.repository }}/blob/main/README.md
            
            # Application-specific labels
            app.version=${{ needs.build-and-test.outputs.version }}
            app.semantic-version=${{ needs.build-and-test.outputs.semantic-version }}
            app.branch=${{ needs.build-and-test.outputs.branch }}
            app.commit=${{ needs.build-and-test.outputs.commit-sha }}
            app.build-date=${{ needs.build-and-test.outputs.build-date }}
            app.build-time=${{ needs.build-and-test.outputs.build-time }}
            app.java-version=21
            app.maven-version=3.9.7
            app.tomcat-version=10.1
            
            # Environment labels
            app.environment=${{ needs.build-and-test.outputs.branch == 'main' && 'production' || (needs.build-and-test.outputs.branch == 'develop' && 'staging' || 'development') }}
            app.stability=${{ needs.build-and-test.outputs.branch == 'main' && 'stable' || 'testing' }}

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.build-and-test.outputs.version }}
            SEMANTIC_VERSION=${{ needs.build-and-test.outputs.semantic-version }}
            BRANCH=${{ needs.build-and-test.outputs.branch }}
            COMMIT=${{ needs.build-and-test.outputs.commit-sha }}
            BUILD_DATE=${{ needs.build-and-test.outputs.build-date }}
            BUILD_TIME=${{ needs.build-and-test.outputs.build-time }}
            GITHUB_SHA=${{ github.sha }}
            GITHUB_REF=${{ github.ref_name }}

      - name: ðŸ·ï¸ Image Digest
        run: |
          echo "## ðŸ³ Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ needs.build-and-test.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Semantic Version:** ${{ needs.build-and-test.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** ${{ needs.build-and-test.outputs.build-date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ¯ Recommended Tags for Different Use Cases:" >> $GITHUB_STEP_SUMMARY
          echo "| Use Case | Tag | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Latest Stable** | \`latest\` | Always points to latest main branch |" >> $GITHUB_STEP_SUMMARY
          echo "| **Specific Version** | \`${{ needs.build-and-test.outputs.version }}\` | Exact build version |" >> $GITHUB_STEP_SUMMARY
          echo "| **Semantic Version** | \`${{ needs.build-and-test.outputs.semantic-version }}\` | Semantic versioning |" >> $GITHUB_STEP_SUMMARY
          echo "| **Date-based** | \`${{ needs.build-and-test.outputs.build-date }}\` | Build by date |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit-specific** | \`${{ needs.build-and-test.outputs.commit-sha }}\` | Exact commit |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`production\`/\`staging\` | Environment-specific |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸš€ Quick Pull Commands:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Latest stable (recommended for production)" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Specific version (recommended for reproducible deployments)" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Semantic version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 3: Security Scan (runs in parallel with docker build)
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: ðŸ” Run OWASP Dependency Check
        run: |
          echo "ðŸ” Running security vulnerability scan..."
          mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7 -B
        continue-on-error: true

      - name: ðŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ needs.build-and-test.outputs.version }}
          path: target/dependency-check-report.html
          retention-days: 14

  # Job 4: Deploy Notification
  deployment-notification:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build-push]
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: ðŸŽ‰ Success Notification
        if: needs.docker-build-push.result == 'success'
        run: |
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ needs.build-and-test.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Quick Start:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull and run the latest image" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8080:8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Access the application" >> $GITHUB_STEP_SUMMARY
          echo "curl http://localhost:8080/webapp-demo/" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure Notification
        if: needs.build-and-test.result == 'failure' || needs.docker-build-push.result == 'failure'
        run: |
          echo "## âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Failure Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Status:** ${{ needs.docker-build-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ needs.build-and-test.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ needs.build-and-test.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the job logs for detailed error information."