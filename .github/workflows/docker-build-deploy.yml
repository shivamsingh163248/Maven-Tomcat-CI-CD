name: Build, Test & Docker Deploy

on:
  push:
    branches: 
      - main
      - develop
      - feature/*
      - release/*
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      branch: ${{ steps.branch.outputs.branch }}
      commit-sha: ${{ steps.version.outputs.commit-sha }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Extract Branch Information
        id: branch
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "branch=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "source-branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            branch_name=${GITHUB_REF#refs/heads/}
            branch_name=${branch_name#refs/tags/}
            # Replace special characters for Docker tag compatibility
            branch_name=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9._-]/-/g' | tr '[:upper:]' '[:lower:]')
            echo "branch=$branch_name" >> $GITHUB_OUTPUT
            echo "source-branch=$branch_name" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”¢ Generate Version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${{ github.ref_name }}
          else
            VERSION="${{ steps.branch.outputs.branch }}-$(date +'%Y%m%d')-${GITHUB_SHA::8}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit-sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ§¹ Clean & Compile
        run: |
          echo "ðŸ§¹ Cleaning and compiling project..."
          mvn clean compile -B

      - name: ðŸ§ª Run Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          mvn test -B
          
      - name: ðŸ“Š Generate Test Reports
        run: |
          echo "ðŸ“Š Generating test and coverage reports..."
          mvn surefire-report:report jacoco:report -B
        if: always()

      - name: ðŸ“¦ Build WAR Package
        run: |
          echo "ðŸ“¦ Building WAR package..."
          mvn package -DskipTests -B

      - name: ðŸ“¤ Upload WAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-war-${{ steps.version.outputs.version }}
          path: target/*.war
          retention-days: 30

      - name: ðŸ“¤ Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ steps.version.outputs.version }}
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 14

      - name: âœ… Build Summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.branch.outputs.source-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ steps.version.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY

  # Job 2: Build and Push Docker Image
  docker-build-push:
    name: ðŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout Repository  
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download WAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp-war-${{ needs.build-and-test.outputs.version }}
          path: target/

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Branch-based tags
            type=ref,event=branch
            # Tag-based releases
            type=ref,event=tag
            # Latest for main branch
            type=raw,value=latest,enable={{is_default_branch}}
            # Version from build job
            type=raw,value=${{ needs.build-and-test.outputs.version }}
            # Commit SHA
            type=sha,prefix={{branch}}-,format=short
          labels: |
            org.opencontainers.image.title=Maven Tomcat Web App
            org.opencontainers.image.description=Java Web Application with Maven and Tomcat
            org.opencontainers.image.vendor=${{ github.repository_owner }}
            org.opencontainers.image.version=${{ needs.build-and-test.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            app.version=${{ needs.build-and-test.outputs.version }}
            app.branch=${{ needs.build-and-test.outputs.branch }}
            app.commit=${{ needs.build-and-test.outputs.commit-sha }}

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.build-and-test.outputs.version }}
            BRANCH=${{ needs.build-and-test.outputs.branch }}
            COMMIT=${{ needs.build-and-test.outputs.commit-sha }}

      - name: ðŸ·ï¸ Image Digest
        run: |
          echo "## ðŸ³ Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ needs.build-and-test.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Available Tags:" >> $GITHUB_STEP_SUMMARY
          tags="${{ steps.meta.outputs.tags }}"
          for tag in $tags; do
            echo "- \`$tag\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pull Command:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Job 3: Security Scan (runs in parallel with docker build)
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: ðŸ” Run OWASP Dependency Check
        run: |
          echo "ðŸ” Running security vulnerability scan..."
          mvn org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7 -B
        continue-on-error: true

      - name: ðŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ needs.build-and-test.outputs.version }}
          path: target/dependency-check-report.html
          retention-days: 14

  # Job 4: Deploy Notification
  deployment-notification:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build-push]
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: ðŸŽ‰ Success Notification
        if: needs.docker-build-push.result == 'success'
        run: |
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ needs.build-and-test.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Quick Start:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull and run the latest image" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8080:8080 \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Access the application" >> $GITHUB_STEP_SUMMARY
          echo "curl http://localhost:8080/webapp-demo/" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure Notification
        if: needs.build-and-test.result == 'failure' || needs.docker-build-push.result == 'failure'
        run: |
          echo "## âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Failure Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Status:** ${{ needs.docker-build-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ needs.build-and-test.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ needs.build-and-test.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the job logs for detailed error information."